= CockroachDB Demo on Minikube
This repository contains instructions for deploying Cockroach with Kuberntes usiung Minikube. Portions of this tutorial are from the official link:https://www.cockroachlabs.com/docs/stable/[CockroachDB] documention, yet are abbreviated and noted were applicable, however this repository includes extras such as setting up HJAproxy on your local machine, etc.

image:images/repo1-main-dashboard.png[]

After working through this lab you will have a highly-available triple-node CockroachDB cluster running within Minukube and fronted by Haproxy  on your local machine.  Included with this lab are instructions for DB/performance tests, monitoring, and a Python Lab to get your started. 

== Assumptions
. This lab is intended to jumpstart your learning and allow you the freedom to explore CockroachDB with minimal effort in your local (home) dev environment.  Please consult the official documentation for getting a production grade set of clusters running. Note that instead of creating a 'tools' VM, this lab is installing software on your local machine.  Also this lab makes use of installing binaries when possible as a matter of personal taste.

= Part 1 - Setting up the Environment

== Requirements
* link:https://www.cockroachlabs.com/docs/stable/install-cockroachdb-mac.html#download-the-binary-1/[CockroachDB]
* link:https://www.virtualbox.org/[Virtualbox]
* link:http://https://kubernetes.io/docs/tasks/tools/install-kubectl/[Kubectl]
* link:https://kubernetes.io/docs/tasks/tools/install-minikube/[Minikube]
* link:https://https://formulae.brew.sh/formula/haproxy/[HAproxy]
* link:https://pypi.org/project/psycopg2/[psycopg2]

== Setup kubectl
. Download and Install kubectl
+
----
$ curl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/darwin/amd64/kubectl"
$ chmod +x ./kubectl
$ sudo mv ./kubectl /usr/local/bin/kubectl
----
. Check for successful installation
+
----
$ kubectl version --client
    Client Version: version.Info { 
    Major:"1",
    Minor:"18",
    GitVersion:"v1.18.4",
    GitCommit:"c96aede7b5205121079932896c4ad89bb93260af",
    GitTreeState:"clean",
    BuildDate:"2020-06-17T11:41:22Z",
    GoVersion:"go1.13.9",
    Compiler:"gc", 
    Platform:"darwin/amd64"
    }
----

== Setup Minikube within Virtualbox
. Make sure link:https://www.virtualbox.org/[Virtualbox] is already installed on your machine.
. Install Minikube
+
----
$ curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-darwin-amd64 && chmod +x minikube
$ sudo mv minikube /usr/local/bin
----
. Start Minikube
+
----
$ minikube start
üòÑ  minikube v1.11.0 on Darwin 10.13.6
üåü  Using the virtualbox driver based on existing profile
üëç  Starting control plane node minikube in cluster minikube
üîÑ  Restarting existing virtualbox VM for "minikube" ...
üê≥  Preparing Kubernetes v1.18.3 on Docker 19.03.8 ...
üîé  Verifying Kubernetes components...
üåü  Enabled addons: default-storageclass, ingress, storage-provisioner
üèÑ  Done! kubectl is now configured to use "minikube"
----
image:images/install-minikube.png[]

== Install CockroachDB 
For simplicity sake, let's start CockroachDB via a standard Kubernetes Config YAML rather than leveraging link:https://helm.sh/[Helm].  We will want to be familiar with what is being deployed, and can inspect the config YAML stateful set. It's is assumed the user may not already be using Helm or new to Kubernetes.

. First lets download and check out what we plan to deploy
+
----
$ curl -O https://raw.githubusercontent.com/cockroachdb/cockroach/master/cloud/kubernetes/cockroachdb-statefulset.yaml
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  8149  100  8149    0     0  17792      0 --:--:-- --:--:-- --:--:-- 17792
...
----

. Open the stateful set and note we will be deploying three replica CockroachDB nodes
+
----
$ cat cockroachdb-statefulset.yaml 
...
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: cockroachdb
spec:
  serviceName: "cockroachdb"
  replicas: 3
  selector:
    matchLabels:
      app: cockroachdb
  template:
    metadata:
      labels:
        app: cockroachdb
...
----

. Deploy the database as a cluster within Minukube
+
----
$ kubectl create -f https://raw.githubusercontent.com/cockroachdb/cockroach/master/cloud/kubernetes/cockroachdb-statefulset.yaml
----

. View the newly created resources.  We have three pods and some services to allow communication. 
+
----
$ kubectl get all

NAME                READY   STATUS    RESTARTS   AGE
pod/cockroachdb-0   1/1     Running   1          1h
pod/cockroachdb-1   1/1     Running   1          1h
pod/cockroachdb-2   1/1     Running   1          1h

NAME                         TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                          AGE
service/cockroachdb          ClusterIP      None             <none>        26257/TCP,8080/TCP               1h
service/cockroachdb-public   ClusterIP      10.106.48.55     <none>        26257/TCP,8080/TCP               1h
service/kubernetes           ClusterIP      10.96.0.1        <none>        443/TCP                          1h

NAME                           READY   AGE
statefulset.apps/cockroachdb   3/3     1h

NAME                     COMPLETIONS   DURATION   AGE
job.batch/cluster-init   0/1           26h        1h
----

== View the CockroachDB Dashboard
What fun would administering a highly available and elastic system without a sweet dashboard?  Lets view the cockroach dashboard and get a feel for what kind of monitoring capabilities we have. However, because Cockroach is running within a virtualized environment on our machine, we need to enable local network access in order to view via a web browser. A feature of CockroachhDB is that Any node in the cluster can be leveraged to access the Console. 

. Set up a local port forward to port 8080 within the kubernetes cluster to the '0' node
+
----
$ kubectl port-forward cockroachdb-0 8080
Forwarding from 127.0.0.1:8080 -> 8080
Forwarding from [::1]:8080 -> 8080
----

. Access the Console from your Chrome browser (preferred): link:http://localhost:8080[http://localhost:8080]

image:images/1-view-dashboard.png[]

== Creating your first Database
Now that we have a fully operational CockroachDB cluster on our system, lets load up our first DB.  We will be leveraging an included packaged SQL client from within the official CockroachDB docker image, allowing it to be temporary as we load items into a fresh schema.

. Fire up a CockroachDB SQL client from within your Kubernetes cluster
+
----
kubectl run cockroachdb -it --image=cockroachdb/cockroach:v20.1.2 --rm --restart=Never -- sql --insecure --host=cockroachdb-public
If you don't see a command prompt, try pressing enter.

root@cockroachdb-public:26257/defaultdb> 
----
. Now let's create the database 'bank' and add some initial tables and entries
+
----
root@cockroachdb-public:26257/defaultdb> CREATE DATABASE bank;
CREATE DATABASE

Time: 87.37572ms
----
+
----
root@cockroachdb-public:26257/defaultdb> CREATE TABLE bank.accounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      balance DECIMAL
  );
CREATE TABLE

Time: 69.467532ms
----
+
----
root@cockroachdb-public:26257/defaultdb> INSERT INTO bank.accounts (balance)
  VALUES
      (1000.50), (20000), (380), (500), (55000);
INSERT 5

Time: 40.176844ms
----
. Let's confirm this data exists and ready for use
+
----
root@cockroachdb-public:26257/defaultdb> SELECT * FROM bank.accounts;
                   id                  | balance
---------------------------------------+----------
  19cb2405-0346-4796-99e0-cd40f35b565d |     380
  2a5d7a25-8669-4073-9a57-9a3168ea3fc0 |   55000
  49450989-d5d9-457b-86ea-e31c492c81f9 |     500
  ac1c0c21-f12f-4557-95e5-84041278a651 | 1000.50
  f79eeab7-ac6a-4c23-8ac3-4223a808b1d0 |   20000
(5 rows)

Time: 75.7201ms
----
. We are finished with DB creation and can now quit the shell and destroy the temp container
+
----
root@cockroachdb-public:26257/defaultdb> \q
pod "cockroachdb" deleted
----

== Congratulations!
You have successfully set up CockroachDB on your system with Kubernetes!

= Part 2 - Behaviour & Performance Monitoring 

Now we will test the behaviour and performance of CockroachDB under various circumstances including failing nodes, and workloads.  Since we are in a home lab, it is necessary for us to set up and configure a proxy to the cluster residing in the Minikube environment. We will first set up HAproxy to get our system wired up for communicating from our local workstation into the Minukube cluster. 

CockroachDB ships with come goodness that makes working with HAproxy easier.  Included is an HAproxy config file generator which we can leverage to more easily build a config which allows us to loadbalance into our cluster.

== Install CockroachDB locally
. Download the CockroachDB bits and move to a user accessible location
+
----
$ curl https://binaries.cockroachdb.com/cockroach-v20.1.2.darwin-10.9-amd64.tgz | tar -xJ
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 40.3M  100 40.3M    0     0  10.6M      0  0:00:03  0:00:03 --:--:-- 10.6M
----
+
----
$ sudo cp -i cockroach-v20.1.2.darwin-10.9-amd64/cockroach /usr/local/bin/
----
+
----
$ which cockroach
/usr/local/bin/cockroach
----

== Generate an HAproxy config via CockroachDB's generator

. Open the necessary ports for accessing the cluster's ingress service on port 26257
+
----
$ kubectl port-forward service/cockroachdb-public 26257
Forwarding from 127.0.0.1:26257 -> 26257
Forwarding from [::1]:26257 -> 26257
----
. In a second shell session with the port forwarding currently running, leverage the CockroachDB HAProxy config generator specifying your localhost:26257 address on the port. A file called haproxy.cfg will be created in the directory this tool is run.
+
----
$ cockroach gen haproxy --insecure --host=127.0.0.1 --port=26257
----
+
. View the newly created HAproxy config file.  Notice the default host names created for us. We will need to configure our system to understand these mappings later.  At this point you can close your port-forward session.
+
----
$ cat haproxy.cfg 

global
  maxconn 4096

defaults
    mode                tcp
    # Timeout values should be configured for your specific use.
    # See: https://cbonte.github.io/haproxy-dconv/1.8/configuration.html#4-timeout%20connect
    timeout connect     10s
    timeout client      1m
    timeout server      1m
    # TCP keep-alive on client side. Server already enables them.
    option              clitcpka

listen psql
    bind :26257
    mode tcp
    balance roundrobin
    option httpchk GET /health?ready=1
    server cockroach1 cockroachdb-0.cockroachdb.default.svc.cluster.local:26257 check port 8080
    server cockroach2 cockroachdb-2.cockroachdb.default.svc.cluster.local:26257 check port 8080
    server cockroach3 cockroachdb-1.cockroachdb.default.svc.cluster.local:26257 check port 8080
----

== Run HAproxy with the CockroachDb HAproxy Config file

Did I mention this isnt an HAproxy lab?  It isn't! However we may not already have it available on our system.  We will use the Brew package manager for Mac to install this quickly.

. Install Haproxy
+
----
$ brew install haproxy
----
+
----
$ which haproxy
/usr/local/bin/haproxy
----

. Start the proxy with the generated config file
+
----
$ haproxy -f haproxy.cfg
[ALERT] 169/102000 (21502) : parsing [haproxy.cfg:20] : 'server cockroach1' : could not resolve address 'cockroachdb-0.cockroachdb.default.svc.cluster.local'.
[ALERT] 169/102000 (21502) : parsing [haproxy.cfg:21] : 'server cockroach2' : could not resolve address 'cockroachdb-2.cockroachdb.default.svc.cluster.local'.
[ALERT] 169/102000 (21502) : parsing [haproxy.cfg:22] : 'server cockroach3' : could not resolve address 'cockroachdb-1.cockroachdb.default.svc.cluster.local'.
[ALERT] 169/102000 (21502) : Failed to initialize server(s) addr.
----

Note the errors above, can you determine why this did not work?  If you guessed that we werent able to resolve DNS you were correct. Before we go setting up DNS servers or modifying system files, lets make sure we can communicate properly between our local system and our cluster's services.

== Enable Cluster upport for Haproxy loadbalancing
. Create services to expose each CockroachDB pod we with to loadbalance traffic to
+
----
$ kubectl expose pod/cockroachdb-0 --type=LoadBalancer --name=cockroachdb-pod0
service/cockroachdb-pod0 exposed

$ kubectl expose pod/cockroachdb-1 --type=LoadBalancer --name=cockroachdb-pod1
service/cockroachdb-pod1 exposed

$ kubectl expose pod/cockroachdb-2 --type=LoadBalancer --name=cockroachdb-pod2
service/cockroachdb-pod2 exposed
----

. Ensure communication between HAproxy and Minikube with Minikube's communication 'tunnel'. Starting the tunnel is simple.  Note the previously created cluster services are listed.
+
----
$ minikube tunnel

Status:    
    machine: minikube
    pid: 22499
    route: 10.96.0.0/12 -> 192.168.99.100
    minikube: Running
    services: [cockroachdb-pod0, cockroachdb-pod1, cockroachdb-pod2]
    errors: 
        minikube: no errors
        router: no errors
        loadbalancer emulator: no errors
----

. Let's inspect our cluster services and observe we have External IP addresses assigned to them.
+
----
$ kubectl get svc -w
NAME                 TYPE           CLUSTER-IP       EXTERNAL-IP      PORT(S)                          AGE
cockroachdb          ClusterIP      None             <none>           26257/TCP,8080/TCP               144m
cockroachdb-pod0     LoadBalancer   10.97.133.136    10.97.133.136    26257:31738/TCP,8080:32411/TCP   2m8s
cockroachdb-pod1     LoadBalancer   10.106.246.239   10.106.246.239   26257:30140/TCP,8080:31663/TCP   2m2s
cockroachdb-pod2     LoadBalancer   10.97.97.234     10.97.97.234     26257:32424/TCP,8080:30045/TCP   118s
----

. With the Minukube tunnel still running, Let's test that we can reach the CockroachDB Console via one of thos external IP addresses
+
----
$ curl http://10.97.133.136:8080
<!DOCTYPE html>
<html>
    <head>
        <title>Cockroach Console</title>
...
</html>
----

. Remember the HA config file contained three FQDN for our cluster?  Let's map our newly exposed IP address to those names within our local system's /etc/hosts file. Here I have removed the .local extension and made the cooresponding update with in the haproxy.cfg file
+
----
$ sudo nano /etc/hosts
----
+
----
$ cat /etc/hosts
...
10.97.133.136 cockroachdb-0.cockroachdb.default.svc.cluster
10.106.246.239 cockroachdb-1.cockroachdb.default.svc.cluster
10.97.97.234 cockroachdb-2.cockroachdb.default.svc.cluster
----

. With the Minukube tunnel still running, Test that we can make FQDN requests to our cluster
+
----
$ curl http://cockroachdb-2.cockroachdb.default.svc.cluster:8080/
<!DOCTYPE html>
<html>
    <head>
        <title>Cockroach Console</title>
...
</html>
----

. Update the haproxy.cfg file with the names you set within your hostfile
+
----
$ cat haproxy.cfg 

global
  maxconn 4096

defaults
    mode                tcp
    # Timeout values should be configured for your specific use.
    # See: https://cbonte.github.io/haproxy-dconv/1.8/configuration.html#4-timeout%20connect
    timeout connect     10s
    timeout client      1m
    timeout server      1m
    # TCP keep-alive on client side. Server already enables them.
    option              clitcpka

listen psql
    bind :26257
    mode tcp
    balance roundrobin
    option httpchk GET /health?ready=1
    server cockroach1 cockroachdb-0.cockroachdb.default.svc.cluster:26257 check port 8080
    server cockroach2 cockroachdb-2.cockroachdb.default.svc.cluster:26257 check port 8080
    server cockroach3 cockroachdb-1.cockroachdb.default.svc.cluster:26257 check port 8080
----

. Start HAproxy with your new config file. Expect no errors if you have done everything correctly. Bes ure Minukube tunnel is still rinning first.
+
----
$ haproxy -f haproxy.cfg
----

== Performance Testing and Monitoring CoockroachDB Workloads

