= CockroachDB Demo on Minikube
This repository contains instructions for deploying Cockroach with Kuberntes usiung Minikube. Portions of this tutorial are from the official link:https://www.cockroachlabs.com/docs/stable/[CockroachDB] documention, yet are abbreviated and noted were applicable, however this repository includes extras such as setting up HJAproxy on your local machine, etc.

image:images/repo1-main-dashboard.png[]

After working through this lab you will have a highly-available triple-node CockroachDB cluster running within Minukube and fronted by Haproxy  on your local machine.  Included with this lab are instructions for DB/performance tests, monitoring, and a Python Lab to get your started. 

== Assumptions
. This lab is intended to jumpstart your learning and allow you the freedom to explore CockroachDB with minimal effort in your local (home) dev environment.  Please consult the official documentation for getting a production grade set of clusters running. Note that instead of creating a 'tools' VM, this lab is installing software on your local machine.  Also this lab makes use of installing binaries when possible as a matter of personal taste.

== Requirements
* link:https://www.cockroachlabs.com/docs/stable/install-cockroachdb-mac.html#download-the-binary-1/[CockroachDB]
* link:https://www.virtualbox.org/[Virtualbox]
* link:http://https://kubernetes.io/docs/tasks/tools/install-kubectl/[Kubectl]
* link:https://kubernetes.io/docs/tasks/tools/install-minikube/[Minikube]
* link:https://https://formulae.brew.sh/formula/haproxy/[HAproxy]
* link:https://pypi.org/project/psycopg2/[psycopg2]

== Setup kubectl
. Download and Install kubectl
+
----
$ curl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/darwin/amd64/kubectl"
$ chmod +x ./kubectl
$ sudo mv ./kubectl /usr/local/bin/kubectl
----
. Check for successful installation
+
----
$ kubectl version --client
    Client Version: version.Info { 
    Major:"1",
    Minor:"18",
    GitVersion:"v1.18.4",
    GitCommit:"c96aede7b5205121079932896c4ad89bb93260af",
    GitTreeState:"clean",
    BuildDate:"2020-06-17T11:41:22Z",
    GoVersion:"go1.13.9",
    Compiler:"gc", 
    Platform:"darwin/amd64"
    }
----

== Setup Minikube within Virtualbox
. Make sure link:https://www.virtualbox.org/[Virtualbox] is already installed on your machine.
. Install Minikube
+
----
$ curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-darwin-amd64 && chmod +x minikube
$ sudo mv minikube /usr/local/bin
----
. Start Minikube
+
----
$ minikube start
üòÑ  minikube v1.11.0 on Darwin 10.13.6
üåü  Using the virtualbox driver based on existing profile
üëç  Starting control plane node minikube in cluster minikube
üîÑ  Restarting existing virtualbox VM for "minikube" ...
üê≥  Preparing Kubernetes v1.18.3 on Docker 19.03.8 ...
üîé  Verifying Kubernetes components...
üåü  Enabled addons: default-storageclass, ingress, storage-provisioner
üèÑ  Done! kubectl is now configured to use "minikube"
----
image:images/install-minikube.png[]

== Install CockroachDB 
For simplicity sake, let's start CockroachDB via a standard Kubernetes Config YAML rather than leveraging link:https://helm.sh/[Helm].  We will want to be familiar with what is being deployed, and can inspect the config YAML stateful set. It's is assumed the user may not already be using Helm or new to Kubernetes.

. First lets download and check out what we plan to deploy
+
----
$ curl -O https://raw.githubusercontent.com/cockroachdb/cockroach/master/cloud/kubernetes/cockroachdb-statefulset.yaml
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  8149  100  8149    0     0  17792      0 --:--:-- --:--:-- --:--:-- 17792
...
----

. Open the stateful set and note we will be deploying three replica CockroachDB nodes
+
----
$ cat cockroachdb-statefulset.yaml 
...
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: cockroachdb
spec:
  serviceName: "cockroachdb"
  replicas: 3
  selector:
    matchLabels:
      app: cockroachdb
  template:
    metadata:
      labels:
        app: cockroachdb
...
----

. Deploy the database as a cluster within Minukube
+
----
$ kubectl create -f https://raw.githubusercontent.com/cockroachdb/cockroach/master/cloud/kubernetes/cockroachdb-statefulset.yaml
----

. View the newly created resources.  We have three pods and some services to allow communication. 
+
----
$ kubectl get all

NAME                READY   STATUS    RESTARTS   AGE
pod/cockroachdb-0   1/1     Running   1          1h
pod/cockroachdb-1   1/1     Running   1          1h
pod/cockroachdb-2   1/1     Running   1          1h

NAME                         TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                          AGE
service/cockroachdb          ClusterIP      None             <none>        26257/TCP,8080/TCP               1h
service/cockroachdb-public   ClusterIP      10.106.48.55     <none>        26257/TCP,8080/TCP               1h
service/kubernetes           ClusterIP      10.96.0.1        <none>        443/TCP                          1h

NAME                           READY   AGE
statefulset.apps/cockroachdb   3/3     1h

NAME                     COMPLETIONS   DURATION   AGE
job.batch/cluster-init   0/1           26h        1h
----

== View the CockroachDB Dashboard
What fun would administering a highly available and elastic system without a sweet dashboard?  Lets view the cockroach dashboard and get a feel for what kind of monitoring capabilities we have. However, because Cockroach is running within a virtualized environment on our machine, we need to enable local network access in order to view via a web browser. A feature of CockroachhDB is that Any node in the cluster can be leveraged to access the Console. 

. Set up a local port forward to port 8080 within the kubernetes cluster to the '0' node
+
----
$ kubectl port-forward cockroachdb-0 8080
Forwarding from 127.0.0.1:8080 -> 8080
Forwarding from [::1]:8080 -> 8080
----

. Access the Console from your Chrome browser (preferred): link:http://localhost:8080[http://localhost:8080]

image:images/1-view-dashboard.png[]

== Creating your first Database
Now that we have a fully operational CockroachDB cluster on our system, lets load up our first DB.  We will be leveraging an included packaged SQL client from within the official CockroachDB docker image, allowig it to be temporary as we load items into a fresh schema.

. Fire up a CockroachDB SQL client from within your Kubernetes cluster
+
----
kubectl run cockroachdb -it --image=cockroachdb/cockroach:v20.1.2 --rm --restart=Never -- sql --insecure --host=cockroachdb-public
If you don't see a command prompt, try pressing enter.

root@cockroachdb-public:26257/defaultdb> 
----
. Now let's create the database 'bank' and add some initial tables and entries
+
----
root@cockroachdb-public:26257/defaultdb> CREATE DATABASE bank;
CREATE DATABASE

Time: 87.37572ms
----
+
----
root@cockroachdb-public:26257/defaultdb> CREATE TABLE bank.accounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      balance DECIMAL
  );
CREATE TABLE

Time: 69.467532ms
----
+
----
root@cockroachdb-public:26257/defaultdb> INSERT INTO bank.accounts (balance)
  VALUES
      (1000.50), (20000), (380), (500), (55000);
INSERT 5

Time: 40.176844ms
----
. Let's confirm this data exists and ready for use
+
----
root@cockroachdb-public:26257/defaultdb> SELECT * FROM bank.accounts;
                   id                  | balance
---------------------------------------+----------
  19cb2405-0346-4796-99e0-cd40f35b565d |     380
  2a5d7a25-8669-4073-9a57-9a3168ea3fc0 |   55000
  49450989-d5d9-457b-86ea-e31c492c81f9 |     500
  ac1c0c21-f12f-4557-95e5-84041278a651 | 1000.50
  f79eeab7-ac6a-4c23-8ac3-4223a808b1d0 |   20000
(5 rows)

Time: 75.7201ms
----
. We are finished with DB creation and can now quit the shell and destroy the temp container
+
----
root@cockroachdb-public:26257/defaultdb> \q
pod "cockroachdb" deleted
----
